<!doctype html><html lang=ko><head><title>Write Deadly Simple Compiler Part 2 :: FaultNote</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="내가 처음으로 구독한 개인 메일인 Phil 의 웹 페이지에 있는 2018년 말 포스트인 'Writing a lisp compiler from scratch in JavaScript' 를 학습하며 기록한 글이다."><meta name=keywords content="compiler,parser,asm,llvm"><meta name=robots content="noodp"><link rel=canonical href=https://faultnote.github.io/posts/write-simple-compiler-2/><script async src="https://www.googletagmanager.com/gtag/js?id=G-6J40Z181KC"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6J40Z181KC",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://faultnote.github.io/assets/style.css><link rel=apple-touch-icon href=https://faultnote.github.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://faultnote.github.io/img/favicon/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="ko"><meta property="og:type" content="article"><meta property="og:title" content="Write Deadly Simple Compiler Part 2"><meta property="og:description" content="내가 처음으로 구독한 개인 메일인 Phil 의 웹 페이지에 있는 2018년 말 포스트인 'Writing a lisp compiler from scratch in JavaScript' 를 학습하며 기록한 글이다."><meta property="og:url" content="https://faultnote.github.io/posts/write-simple-compiler-2/"><meta property="og:site_name" content="FaultNote"><meta property="og:image" content="https://faultnote.github.io/img/favicon/orange.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-11-27 22:00:00 +0900 +0900"></head><body class=orange><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>FaultNote</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>소개</a></li><li><a href=/series>연재</a></li><li><a href=/blog>블로그</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>한국어 ▾</li></ul><ul class="language-selector__more hidden"><li><a href=https://faultnote.github.io/en/>English</a></li><li><a href=https://faultnote.github.io/>한국어</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>소개</a></li><li><a href=/series>연재</a></li><li><a href=/blog>블로그</a></li><hr><li><a href=https://faultnote.github.io/en/>English</a></li><li><a href=https://faultnote.github.io/>한국어</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://faultnote.github.io/posts/write-simple-compiler-2/>Write Deadly Simple Compiler Part 2</a></h1><div class=post-meta><span class=post-date>2022-11-27</span>
<span class=post-author>:: soomtong</span>
<span class=post-reading-time>:: 5 min read (2209 words)</span></div><span class=post-tags>#<a href=https://faultnote.github.io/tags/compiler/>compiler</a>&nbsp;
#<a href=https://faultnote.github.io/tags/assembliy/>assembliy</a>&nbsp;
#<a href=https://faultnote.github.io/tags/javascript/>javascript</a>&nbsp;</span><div class=post-content><div><blockquote><p><a href=https://notes.eatonphil.com>Phil</a> 의 &lsquo;Writing a lisp compiler from scratch in JavaScript&rsquo; 첫 포스트의 두 번째 파트인데 분량이 많아 새 포스트를 열었다.</p></blockquote><p>지난 포스트에 이어서&mldr;</p><p>Phil 의 가이드는 S-expression 을 배열 데이터로 만들고 이를 어셈블리 코드(텍스트)로 기록하도록 하고 있다. 그후 어셈블러를 사용하여 실행 가능한 바이너리 파일을 만든다.</p><p>어셈블리는 보통의 사람이 읽을 수 있는 가장 낮은 수준의 프로그래밍 언어로 CPU 의 실제 명령과 1:1 로 대응된다. 그래서 생성된 바이너리 코드는 어셈블리로 쉽게 변환 가능하다.</p><p>어셈블리는 선형으로 구성된다. 비교와 반복을 통해 procedual 하게 코드가 실행된다. 함수가 호출될 때 특정 레지스터에 인자를 담아두고 함수가 종료되면 특정 레지스터에 반환 값이 담긴 후 다음 명령으로 되돌아가기 위해 약속된 레지스터를 참조한다.</p><p>규칙만 잘 알면 단순하고 읽기 쉽다&mldr;🤯 어쨋든, 우리의 프로그램들은 이 과정이 매우 빠르게 반복되는 것 뿐이다.</p><blockquote><p>각 CPU 제조사 마다 CPU 를 위한 명령어(OpCode) 세트가 있고 우리는 이걸 ISA, Instruction Set Architecture 라고 부른다.</p></blockquote><p>이 포스트에서는 x86_64 기준, <code>RDI</code>, <code>RSI</code>, <code>RDX</code> 레지스터에 인자를 담고, <code>RAX</code> 레지서터에 반환 값을 담기로 한다. 함수 호출시 값을 담는 주체도 함수를 호출하는 쪽으로 하자.</p><p>어셈블리 프로그램은 section 으로 구분되어 있다. <code>text</code> 영역에는 읽기만 가능한 프로그램의 코드, 명령들이 있고 CPU 는 이 명령들을 실행하며 다음으로 이동한다. 이동 과정에 CALL, RET, JMP 등 다음 명령어의 위치를 변경하는 명령을 만나 이동하기도 하고 복귀하기도 한다.</p><p>그리고 중요한 부분으로 보통, 프로그램의 시작 위치를 정의하는 부분인 <code>.global main</code> 도 필요하다.
main 은 goto 를 위한 흔한 라벨이다. main 이라는 라벨이 사용될 수 있으니 우리 프로그램의 시작은 <code>_main_</code> 을 사용하도록 하겠다.</p><p>각 어셈블리 코드를 생성하는 emit 이라는 함수를 중심으로 우리가 가진 AST 데이터를 어셈블리 코드로 변환해 보자.</p><h2 id=코드-생성>코드 생성<a href=#코드-생성 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>emit 함수가 생성하는 결과는 소스 코드가 된다. 들여쓰기를 위해 depth 와 기록할 code 를 인자로 받자.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>makeIndent</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>length</span>: <span style=color:#66d9ef>number</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>indentSpace</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>indentSpace</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;\t&#39;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>indentSpace</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>emit</span>(<span style=color:#a6e22e>indentDepth</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>code</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>print</span>: <span style=color:#66d9ef>boolean</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dump</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>makeIndent</span>(<span style=color:#a6e22e>indentDepth</span>)<span style=color:#e6db74>}${</span><span style=color:#a6e22e>code</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>print</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>dump</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>dump</span><span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>n`</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>정상 동작을 확인하기 위한 단순한 테스트 파일도 추가해 본다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>emit</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./compiler&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Emit tab spaces&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return tabbed spaces with text&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expected</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\t\thello&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;hello&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#a6e22e>expected</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>이어서 함수 인자argument를 처리하는 코드와 함수를 호출하고 결과를 저장하는 코드를 생성하는 compile arguement, compile function(label) call 함수를 구성해 보자.</p><p>우리가 가진 AST 구조를 생각해 보자.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>[<span style=color:#e6db74>&#39;+&#39;</span>, <span style=color:#ae81ff>1</span>, [<span style=color:#e6db74>&#39;+&#39;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>]]
</span></span></code></pre></div><p>연산자는 어셈블리로 구성된 함수가 되고 숫자는 레지스터에 할당될 값들이 된다. 함수는 함수 라벨로 표기하여 CPU 명령 처리기가 Jump 할 수 있도록 하고 각 숫자는 리터럴이 된다.</p><p>어셈블리 코드는 아래와 같은 형식으로 시작하고 시스템 콜을 통해 종료된다. (예시는 요즘 macOS 기준)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>  <span style=color:#a6e22e>.global</span> <span style=color:#66d9ef>_main_</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>.text</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 프로그램 코드...
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>  <span style=color:#75715e>// 프로그램 코드...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MOV</span> <span style=color:#66d9ef>RDI</span>, <span style=color:#66d9ef>RAX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MOV</span> <span style=color:#66d9ef>RAX</span>, <span style=color:#ae81ff>0x2000001</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SYSCALL</span>
</span></span></code></pre></div><p>우리의 샘플 AST 는 두 번의 <code>ADD</code> 연산을 하게 될 예정이고 이 함수는 <code>plus:</code> 라는 라벨을 달고 재사용할 것이다.</p><p>어셈블리 수준에서 함수 호출 기능은 아래와 같은 형식으로 구성될 수 있다.</p><ol><li>연산에 사용될 인자를 레지스터에 저장하기 위해 레지스터의 이전 값을 저장 → 각 레지스터를 스택에 저장 → 호출하는 함수 인자에 갯수 만큼만 스택에 올리면 된다.</li><li>우리 수준에서, 최대 3개까지 사용 가능한 인자들을 레지스터에 저장 (순서대로)</li><li>함수 호출 → 더하기 기능을 하는 프로시져로 이동 → 코드 실행 후 RET 명령으로 복귀</li><li>스택에 저장된 레지스터 값을 복원 (저장한 역순으로)</li><li>결과 값이 저장된 레지스터에서 값을 확인</li></ol><p>Phil 의 코드를 참고로 좀 더 진행해 보자.</p><p>파라미터를 위한 3개의 레지스터를 준비하고, 어셈블리 내장 함수를 감싼 plus 함수 라벨도 준비해 두었다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>OpCode</span> {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;+&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;+&#39;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Register</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>RDI</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;RDI&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>RSI</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;RSI&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>RDX</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;RDX&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>RAX</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;RAX&#39;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ArgRegisters</span>: <span style=color:#66d9ef>Register</span>[] <span style=color:#f92672>=</span> [<span style=color:#a6e22e>Register</span>.<span style=color:#a6e22e>RDI</span>, <span style=color:#a6e22e>Register</span>.<span style=color:#a6e22e>RSI</span>, <span style=color:#a6e22e>Register</span>.<span style=color:#a6e22e>RDX</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>BuiltinFunctions</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>OpCode</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>string</span>&gt; <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;+&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;plus&#39;</span>,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>함수 호출 생성하기 위한 compileFnCall 함수를 작성해 보자. 위에서 안내한 pseudo 코드를 옮기면 된다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>compileFnCall</span>(<span style=color:#a6e22e>functionLabel</span>: <span style=color:#66d9ef>OpCode</span>, <span style=color:#a6e22e>args</span>: <span style=color:#66d9ef>Literal</span>[], <span style=color:#a6e22e>destination?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dump</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dump</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>reduce</span>((<span style=color:#a6e22e>acc</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>index</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>acc</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>`PUSH </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>ArgRegisters</span>[<span style=color:#a6e22e>index</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }, <span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dump</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>reduce</span>((<span style=color:#a6e22e>acc</span>, <span style=color:#a6e22e>arg</span>, <span style=color:#a6e22e>index</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>acc</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>compileArgument</span>(<span style=color:#a6e22e>arg</span>, <span style=color:#a6e22e>ArgRegisters</span>[<span style=color:#a6e22e>index</span>]);
</span></span><span style=display:flex><span>  }, <span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dump</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>`CALL </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>BuiltinFunctions</span>[<span style=color:#a6e22e>functionLabel</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>functionLabel</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dump</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>reduceRight</span>((<span style=color:#a6e22e>acc</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>index</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>acc</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>`POP </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>ArgRegisters</span>[<span style=color:#a6e22e>index</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }, <span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>destination</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dump</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>`MOV </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>destination</span><span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>Register</span>.<span style=color:#a6e22e>RDX</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dump</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>스택에 올린 기존 레지스터 값들은 역순으로 복원하기 위해 reduceRight 를 사용했다.</p><p>다시 한 번 우리의 AST 를 보자.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>[<span style=color:#e6db74>&#39;+&#39;</span>, <span style=color:#ae81ff>1</span>, [<span style=color:#e6db74>&#39;+&#39;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>]]
</span></span></code></pre></div><p>인자 보관용으로 사용할 레지스터를 스택에 올려 두었다면 AST 의 첫 번째 인자를 OpCode 로 할당하고 이어지는 인자를 OpCode 의 인자가 될 리터럴로 간주하여 레지스터에 올려두어야 한다.</p><p>이 과정에서 이어지는 인자가 배열인 경우는 또 다른 함수 호출이 예상되기 때문에 또 다시 OpCode 가 호출되는 재귀 함수 구성을 가지게 된다.</p><p>그래서 인자를 compile 하는 함수는 인자가 배열일 경우를 구분하여 어샘블리 코드를 emit 하도록 하자.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>compileArgument</span>(<span style=color:#a6e22e>arg</span>: <span style=color:#66d9ef>Literal</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>Literal</span>[], <span style=color:#a6e22e>destination</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (Array.<span style=color:#a6e22e>isArray</span>(<span style=color:#a6e22e>arg</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>opcode</span>, ...<span style=color:#a6e22e>rest</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>arg</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>compileFnCall</span>(<span style=color:#a6e22e>opcode</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>OpCode</span>, <span style=color:#a6e22e>rest</span>, <span style=color:#a6e22e>destination</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>`MOV </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>destination</span><span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>arg</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>배열이 아닌 일반 리터럴이라면 대상 레지스터에 값을 지정하는 것으로 충분하다.</p><p>이제 테스트 코드를 추가하고 AST 를 받아 어셈블리로 컴파일하는 코드를 작성하자.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Emit compiled code for arguments with destication&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return single move statement&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expected</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\tMOV RDI, 1\n&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>compileArgument</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;RDI&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#a6e22e>expected</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should call compileCall function when got array of arguments&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expected</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>tPUSH RDI
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      // ...`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>compileArgument</span>([<span style=color:#e6db74>&#39;+&#39;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>], <span style=color:#e6db74>&#39;RSI&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#a6e22e>expected</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Emit compiled code for function call with opcode and arguments&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should return basic assembly code&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expected</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>tPUSH RDI 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      // ...`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>compileFnCall</span>(<span style=color:#e6db74>&#39;+&#39;</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>OpCode</span>, [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#a6e22e>expected</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>이제 어셈블리 본문을 완성해 보자. 먼저 prefix, postfix 용 함수를 추가하자. prefix 쪽에 plus 라벨을 가진 ADD 함수를 작성해 두었다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>emitPrefix() {</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;.global _main_&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;.text&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;plus:&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;ADD RDI, RSI&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;MOV RAX, RDI&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;RET&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;_main_:&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>emitPostfix() {</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;MOV RDI, RAX&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Set exit arg in macOS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;MOV RAX, 0x2000001&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Set syscall number
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>emit</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;SYSCALL&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>이 모든 작업을 완성시킬 compile 함수는 아래와 같다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>compile</span>(<span style=color:#a6e22e>ast</span>: <span style=color:#66d9ef>Literal</span>[]) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>opcode</span>, ...<span style=color:#a6e22e>rest</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>ast</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emitPrefix</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>compileFnCall</span>(<span style=color:#a6e22e>opcode</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>OpCode</span>, <span style=color:#a6e22e>rest</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emitPostfix</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>각 emit 함수가 반환하는 값을 모아서 처리하는 구문은 생략되었으니 저장소의 소스코드를 참고;
<a href=https://github.com/soomtong/simple-lisp-compiler>https://github.com/soomtong/simple-lisp-compiler</a></p></blockquote><p>사용된 테스트 코드를 살펴 보자.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;Emit basic AST into assembly code&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should emit a assembly code!&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expected</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`// skipped whitespace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  .global _main_
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  .text
</span></span></span><span style=display:flex><span><span style=color:#e6db74>plus:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ADD RDI, RSI
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  MOV RAX, RDI
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  RET
</span></span></span><span style=display:flex><span><span style=color:#e6db74>_main_:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  PUSH RDI
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  // ...
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  MOV RAX, 0x2000001
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  SYSCALL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>compile</span>([<span style=color:#e6db74>&#39;+&#39;</span>, <span style=color:#ae81ff>1</span>, [<span style=color:#e6db74>&#39;+&#39;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>]]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#a6e22e>expected</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>자동으로 스택이 관리되는 것이 이해되면 다음 파트로 이동해 보자.</p></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://faultnote.github.io/assets/main.js></script>
<script src=https://faultnote.github.io/assets/prism.js></script>
<script src=https://faultnote.github.io/assets/languageSelector.js></script></div></body></html>